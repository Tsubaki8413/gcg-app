# GCG Mobile Analyzer 要件定義書（完全網羅・最終確定版）

**作成日**: 2025年12月23日
**プロジェクト名**: GCG Mobile Analyzer
**ステータス**: **要件定義完了 / 開発待機中**

## 1. プロジェクト概要

### 1.1. 目的
「GUNDAM CARD GAME」のデッキ構築、分析、対戦シミュレーション、および画像共有を、スマートフォンを用いて快適に行うための個人用Webアプリケーションの開発。

### 1.2. ターゲット & 利用シーン
* **ターゲット**: 開発者本人（個人利用）。
* **認証**: アプリ自体のログイン機能はなし（システム内部で `user_id = 1` を固定で使用）。
    * **セキュリティ**: AWS等の公開サーバーへデプロイする際は、Webサーバー側（Apache/Nginx）で**Basic認証**を設定し、関係者以外のアクセスを遮断する。
* **シーン**: 移動中のスマホ利用（メイン）、自宅でのPC利用（サブ）。

### 1.3. 開発方針
* **SPA (Single Page Application)**: 画面遷移ごとのリロード（白画面）を完全に排除し、アプリのような滑らかな操作感を実現する。
* **Mobile First**: スマホの縦画面操作に特化したUI/UX設計。
* **Persistence**: 編集中のデータ消失防止や、誤操作を防ぐ画面遷移を徹底する。
* **Performance**: 将来的なカード枚数増加（1000枚以上）を見据え、**仮想スクロール**や**画像圧縮**を導入して軽快な動作を維持する。

---

## 2. システム構成・技術スタック

### 2.1. フロントエンド
* **Framework**: React 18 (Vite)
* **Routing**: `react-router-dom` (ページ遷移時のリロード回避)
* **Language**: TypeScript
* **Libraries**:
    * `react-window` または `react-virtuoso` (**仮想スクロール用**)
    * `recharts` (グラフ描画)
    * `html2canvas` (画像生成)
    * `framer-motion` (推奨: モーダル等のアニメーション)

### 2.2. バックエンド
* **Language**: PHP 8.x (Plain PHP / フレームワークなし)
* **Hosting**: AWS EC2 (Amazon Linux 2023 / Ubuntu)

### 2.3. データベース
* **Database**: MySQL 8.0
* **Charset**: `utf8mb4_unicode_ci`

---

## 3. 画面構成と機能詳細（UI/UX）

アプリは**フッターナビゲーション（3ボタン）**で主要画面を切り替え、デッキ操作は専用のフローで行う。
**重要**: すべての画面遷移においてブラウザのリロードは発生させない。

### 3.1. 共通レイアウト
* **フッターメニュー**:
    1.  **CARD LIST** (カード検索・閲覧)
    2.  **DECK LIST** (デッキ一覧・管理)
    3.  **SOLO PLAY** (一人回し・モックアップ)
* **UI制御**:
    * **リロード事故防止**: CSSで `overscroll-behavior-y: none` を指定し、スマホでの意図しないプルダウン更新（リロード）を防ぐ。

### 3.2. CARD LIST（カード一覧・検索画面）
* **表示形式**:
    * **5列グリッド表示**: スマホ画面で横に5枚並ぶ密度で表示。
    * **仮想スクロール (Virtual Scrolling)**: 画面描画範囲のみをレンダリングし、メモリ負荷とカクつきを防ぐ。
* **カード手動登録（フライング情報対応）**:
    * 画面ヘッダー等に「＋」ボタンを設置。
    * **登録フォーム**:
        * ID、名前、ステータス（コスト、色、特徴など）を入力。
        * **ID自動整形**: 入力されたIDは保存時に強制的に**大文字**へ変換する。
        * **画像アップロード**: スマホ内の画像を選択し、サーバーへアップロードする。
        * **画像圧縮処理**: サーバー側で受け取った画像を、**長辺800px程度・WebP形式**等にリサイズ・圧縮して保存する。
    * **データ更新・維持ルール**:
        * 手動登録データはDBに保存される。
        * 公式データ（スクレイピング/CSV）取込時、**同じIDが存在すれば公式データで上書き**する。
        * **重要**: 公式データにそのIDが存在しない場合（未取得など）、手動登録したデータは**削除・変更せずそのまま維持**する。
* **詳細モーダル**:
    * 画像タップで表示。
    * **ナビゲーション機能**: モーダルを開いたまま、画面端の大きな「＜ ＞」ボタンで**検索結果リスト内の前後のカードへ移動**できる。
    * **キャッシュ対策**: 画像URL末尾にタイムスタンプ等を付与し、画像更新時のキャッシュ残りを防ぐ。
    * **リンク情報（逆引き）**:
        * **UNIT**の場合、そのユニットに搭乗可能なパイロット一覧を部分一致検索で抽出し表示する。
* **検索・絞り込み機能**:
    * **フリーワード検索（配置）**: 全画面フィルタ内ではなく、**リスト画面のヘッダー（常にリストが見える状態）**に配置する。
    * **検索対象**: 名前、テキスト、特徴、ID（すべて部分一致）。
    * **詳細フィルタ**: 検索窓横のアイコンから**全画面オーバーレイ**で設定（コスト、色、種類、レアリティ、レベル、AP/HP、弾、特徴、地形）。
    * **ソート機能**:
        * コスト、レアリティ、レベル、AP、HP、型番（ID）。
        * **IDソート仕様**: **Natural Sort**（数値順）で並べる（`ST01-2` < `ST01-10`）。

### 3.3. DECK LIST（デッキ一覧・管理画面）
* **一覧表示内容**:
    * **デッキタイトル**: その場で変更（リネーム）可能。
    * **サムネイル画像**:
        * 優先順位: **手動設定** > 種類(UNIT) > レベル(高) > コスト(高) > レアリティ(高) > ID(若)。
    * **警告インジケーター（⚠️）**:
        * 50枚ではない。 / 同名5枚以上 / 3色以上（2色までOK）。
        * 3色以上使用している（2色までOK）。
        * **同番カード過多**: IDのベース部分（型番）が同一のカードが、パラレルを含めて合計5枚以上入っている場合に警告を出す。
* **操作アクション**:
    * **[選択]**: プレビューへ遷移。
    * **[新規作成]**: 空デッキ作成→エディタへ。
    * **[複製]**: 既存デッキをコピー。
    * **[一括削除]**: 編集モードでチェックボックスを表示し、**複数選択して一括削除**を実行。

### 3.4. DECK PREVIEW（プレビュー・分析画面）
* **表示内容**:
    * **カード画像一覧**: 自動整列（Type > Level > Cost > Count > ID）。
    * **サムネイル**: 現在サムネイル設定されているカードに枠線と「サムネイル」ラベルを表示。任意のカードを手動設定可能。
    * **詳細モーダル**: ここでも画像タップで詳細＆イラスト切替が可能。
    * **描画仕様**: `html2canvas`での画像生成を確実にするため、この画面では**仮想スクロールを使用せず**、全カードをDOM描画する。
* **アクション**:
    * **[編集]**: DECK EDITORへ。
    * **[画像保存]**: デッキ全体を1枚の画像（Canvas）として生成・ダウンロード。**ヘッダーにデッキタイトルを描画**する。
* **分析**:
    * コスト分布、色配分、タイプ配分、レベル配分、特徴配分、地形配分グラフ。

### 3.5. DECK EDITOR（構築画面）
* **画面レイアウト**:
    * **上部（Deck Area）**: **固定（Sticky）**表示。初期高さ2段確保。スタック表示。クリックで削除。
    * **下部（Card Pool）**: **4列グリッド**。**仮想スクロール**適用推奨。
* **操作**:
    * **枚数バッジ**: 画像右上に現在の投入枚数を表示。
    * **[－] [＋] ボタン**: 画像下部に配置して増減操作。
* **トークン対応**: `type` が「TOKEN」のカードはプールに表示されるが、**[＋][－]ボタンを表示せず**、デッキに入らないようにする。
* **データ保護**:
    * **LocalStorage保存**: 編集ごとにブラウザに一時保存。リロード時はそこから復元。
    * **離脱警告**: 保存せずに移動しようとするとアラート表示。

### 3.6. DATA MANAGEMENT（設定・データ管理）
* **エクスポート（バックアップ）**:
    * DB内の「全カード」「全デッキ」を**JSONテキストファイル**として出力・ダウンロード。
    * **仕様**: 画像データは含めない。画面には「画像は別途バックアップが必要です」と注意書きを表示する。
* **インポート（復元）**:
    * JSONファイルを読み込みDBへ反映。
    * **必須順序**: 参照エラー回避のため、**Cardsテーブル → Decksテーブル** の順で処理する。
    * **マージルール**: IDが重複した場合、**データの `updated_at`（更新日時）が新しい方を優先**して残す。
* **ID修正ツール**:
    * 手動登録でIDを間違えた際のために、古いIDを新しいIDに置換、または削除する機能（APIまたは簡易UI）。
    * **一括置換**: 実行時、`decks`テーブル内のJSONデータ（構築情報）も走査し、該当IDが含まれていれば新しいIDに書き換える処理を必ず行う。

### 3.7. SOLO PLAY（レイアウト・モックアップ）
**開発ステータス**: **UIレイアウト実装のみ（ロジックなし・操作不可）** 短期間での完成を優先するため、複雑な処理を排除し「見た目（枠）」のみを実装する。
* **目的**:
    * プレゼンテーション用、および将来的な機能実装に向けた画面領域の確保。
    * 実際のゲームプレイ機能（シミュレーター）は持たせない。
* **実装範囲（張りぼて）**:
    * **静的表示**: 画面を上下に分割し、対戦フィールドの「枠」と「仮のカード画像」を配置して表示する。
    * **操作制限**: ドラッグ＆ドロップ、タップによるカード回転、デッキ操作、フェーズ進行などの動的機能は**一切実装しない**。
* **画面構成（縦画面レイアウト）**:
    * コンポーネントを共通化し、上下に対称配置する。
    1.  **OPPONENT（相手）エリア**（画面上部）
        * 手札（裏面画像）、デッキ、トラッシュ、ライフ、ベース、リソース等の置き場所（枠）を表示。
        * フィールド（仮のカード画像を数枚配置しておく）。
    2.  **PLAYER（自分）エリア**（画面下部）
        * 手札（裏面画像）、デッキ、トラッシュ、ライフ、ベース、リソース等の置き場所（枠）を表示。
        * フィールド（仮のカード画像を数枚配置しておく）。
    3.  **簡易情報エリア**
        * ターン数やデッキ枚数等の「見た目」のみ配置する（数値は固定、または変化しない）。

### 3.8. DESIGN SYSTEM（デザイン要件）
* **テーマ: ライトモード（Light Mode）**
    * 清潔感と視認性を重視した「青×白」ベースのデザイン。
* **カラーパレット**:
    * **Main Background**: `#F5F7FA` (薄いブルーグレー) - 長時間の閲覧でも疲れにくい色。
    * **Surface**: `#FFFFFF` (白) - カードリストやモーダルの背景。
    * **Primary Color**: `#0056D2` (Federation Blue) - ヘッダー、決定ボタン、アクティブ状態。
    * **Text Color**: `#333333` (Main), `#666666` (Sub)。
    * **Functional**: `#D32F2F` (Danger/削除), `#2E7D32` (Success/保存)。
* **コンポーネントスタイル**;
    * **Card Shadow**: `box-shadow: 0 2px 4px rgba(0,0,0,0.1)` - 白背景に埋没しないよう薄い影を付与。
    * **Border Radius**: `4px` - `8px` 少し丸みを持たせ、モダンで親しみやすい形状にする。
    * **Buttons**:
        * Primary: 青背景＋白文字。
        * Secondary: 白背景＋青枠線。
* **タイポグラフィ（フォント）**:
    * **Font Family: システム標準フォント** (System Default)
        * iOS: San Francisco
        * Android: Roboto
        * Windows: Yu Gothic UI / Meiryo
    * **理由**: デバイスごとの最適化による最高の可読性と、読み込み遅延のない高速な描画を実現するため。

---

## 4. データベース設計（MySQL）

### 4.1. `cards` テーブル
トークン判別のため `type` カラムの運用を徹底する。

| カラム名 | 型 | インデックス | 備考 |
| --- | --- | --- | --- |
| `id` | VARCHAR(50) | **PK** | 型番 (**大文字統一**)。パラレル等は`_P`等を付与 |
| `name` | VARCHAR(255) | INDEX | 同名検索用 |
| `color` | VARCHAR(50) | INDEX | |
| `type` | VARCHAR(50) | INDEX | **'TOKEN'** を含む |
| `rarity` | VARCHAR(50) | | |
| `expansion_set` | VARCHAR(50) | INDEX | |
| `cost` | INT | INDEX | |
| `level` | INT | INDEX | |
| `ap` | INT | INDEX | |
| `hp` | INT | INDEX | |
| `text` | TEXT | | 部分一致検索対象 |
| `zone` | VARCHAR(50) | INDEX | 地形 |
| `traits` | TEXT | | 特徴 (部分一致) |
| `link` | TEXT | | リンク/搭乗情報 (部分一致) |
| `image_url` | VARCHAR(255) | | 画像ファイル名 (WebP) |
| `updated_at` | DATETIME | | マージ判定用 |

### 4.2. `decks` テーブル

| カラム名 | 型 | 説明 |
| --- | --- | --- |
| `id` | VARCHAR(50) | **PK** UUID |
| `user_id` | VARCHAR(50) | 固定値 `1` |
| `title` | VARCHAR(255) | デッキ名 |
| `cards` | JSON | 構成データ `{"ST01-001": 3, "ST01-001_P": 1...}` |
| `thumbnail_id` | VARCHAR(50) | 手動設定サムネイルID |
| `created_at` | DATETIME | |
| `updated_at` | DATETIME | マージ判定用 |

---

## 5. バックエンド実装ロジック（重要事項）

1.  **`card_manager.php` (手動登録・削除)**:
    * **ID処理**: 入力IDを `strtoupper()` で大文字化。
    * **画像処理**: `GD` または `ImageMagick` を使用し、アップロード画像を長辺800px・画質80%程度のWebPに変換して保存。
    * **DB保存**: `INSERT ... ON DUPLICATE KEY UPDATE` を使用。
    * **削除制御**: カード削除リクエスト時、**`decks`テーブルを走査し、JSON内に該当IDが含まれているか確認する**。
        * **含まれている場合**: 削除をブロックし、エラーメッセージ（409 Conflict）を返す。
        * **含まれていない場合**: 削除を実行する。
2.  **`get_cards.php` (検索)**:
    * **Natural Sort**: IDソート時、PHP側で `strnatcasecmp` を用いて並び替えを行う。
3.  **`import.php` (公式データ取込)**:
    * **削除禁止**: `DELETE FROM cards` は行わない。
    * **更新ロジック**: CSVを1行ずつ読み込み、`INSERT ... ON DUPLICATE KEY UPDATE` で上書きする（CSVにない手動データは消えない）。
4.  **`data_sync.php` (バックアップ復元)**:
    * **順序**: 必ず `Cards` の同期処理を完了させてから `Decks` の同期を行う。
    * **日時比較**: `existing_date < new_date` の場合のみUPDATEを実行。
5.  **`id_manager.php` (ID修正ツール)**:
    * **修正ロジック**: `cards`テーブルのIDを更新すると同時に、**全デッキデータの`cards`カラム（JSON）を走査・置換**する。
    * トランザクションを用いて、両方の更新が成功した場合のみコミットする。

---

## 6. ファイル・ディレクトリ構成（完全版）

必要なすべてのファイル（アプリ本体、API、管理ツール、セットアップ）を網羅。

### 6.1. バックエンド (PHP/Apache)
`htdocs` または `/var/www/html` 配下。

```text
/var/www/html/
├── api/                     # フロントエンドが叩くAPIエンドポイント
│   ├── db_connect.php       # DB接続設定（共通）
│   ├── get_cards.php        # カード検索・取得（Natural Sort対応）
│   ├── deck_operations.php  # デッキ一覧・保存・削除・詳細
│   ├── card_manager.php     # 手動登録・画像アップロード・サーバー側圧縮・削除（使用中チェック）
│   ├── data_sync.php        # データのJSONエクスポート・インポート
│   └── id_manager.php       # ID誤登録時の修正・削除ツール（デッキJSON一括置換付き）
│
├── admin_tools/             # 運用・開発者用ツール
│   ├── scrape.php           # [★作成済み] 公式サイト等からの情報取得スクリプト
│   └── import.php           # [★作成済み] 取得データのDB投入（Upsert/削除禁止ロジック）
│
├── images/                  # カード画像保存先（権限: 777 or www-data）
│   ├── ST01-001.webp        # 圧縮済み画像
│   └── ...
│
├── setup/
│   └── setup.sql            # [★作成済み] DBテーブル作成用SQL
│
└── index.php                # API動作確認用
```

### 6.2. フロントエンド (React/Vite)
`src` ディレクトリ配下。

```text
/src/
├── assets/                  # 静的リソース
├── components/
│   ├── common/              # 共通UI
│   │   ├── Header.tsx       # 検索窓(フリーワード)付きヘッダー
│   │   ├── Footer.tsx       # 3ボタンナビゲーション
│   │   ├── Modal.tsx        # 汎用モーダル枠
│   │   └── Alert.tsx        # 警告・確認ダイアログ
│   ├── features/            # 機能別コンポーネント
│   │   ├── CardList/
│   │   │   ├── CardGrid.tsx # 仮想スクロール(Virtual Scroll)実装
│   │   │   └── FilterOverlay.tsx
│   │   ├── Deck/
│   │   │   ├── DeckList.tsx
│   │   │   ├── DeckEditor.tsx
│   │   │   └── DeckPreview.tsx # 仮想スクロール不使用(画像保存用)
│   │   └── SoloPlay/
│   │       └── PlayMat.tsx
│   └── CardDetail/
│       └── CardDetailModal.tsx # イラスト切替(小ボタン/ID判定)・Nav・リンク情報
├── hooks/                   # ロジック切り出し
│   ├── useCards.ts          # 検索・API通信
│   ├── useDeck.ts           # デッキ操作
│   ├── useImageExport.ts    # 画像生成処理
│   └── useVirtualScroll.ts  # スクロール制御
├── types/
│   └── index.ts             # Card, Deck等の型定義
├── App.tsx                  # ルーティング設定
├── main.tsx                 # エントリーポイント
└── ...
```

---

## 7. 開発・導入ステップ (Roadmap)

基盤となるデータ部分が完成したため、以下の順序で実装を進めることで、手戻りなく効率的に開発を行う。

**STEP 1: インフラ構築とデータ投入（完了）**
1.  **データベース構築**:
    * MySQLで`gcg_app`データベースを作成。
    * 完成済みの`setup.sql`を流し込み、テーブル (`cards`, `decks`) とインデックスを作成する。
2.  **データ取得**:
    * `scrape.php`を実行し、公式情報と画像（WebP圧縮済み）を取得する。
    * 生成された`cards.csv`と`images/`フォルダを確認する。
3.  **データインポート**:
    * `import.php`を実行し、CSVデータをDBへ格納する。

**STEP 2: バックエンドAPI実装（完了）**
1.  **DB接続**: `db_connect.php`を作成し、疎通確認。
2.  **カード取得**: `get_cards.php`を実装し、ブラウザでJSONが正しく返るか確認（Natural Sortの挙動確認）。
3.  **デッキ操作**: `deck_operations.php`（保存・読み込み・削除）の実装。
    * この段階ではPostmanやcURLでAPIの動作テストを行う。
4.  **他ファイル作成**: `card_manager.php`, `data_synk.php`, `id_manager.php`を実装。

**STEP 3: フロントエンド基盤構築（完了）**
1.  **React環境構築**: Viteでプロジェクトを作成し、必要なライブラリ（`react-router-dom`, `react-virtuoso`等）をインストール。
2.  **共通コンポーネント**: ヘッダー、フッター、レイアウト枠を作成。
3.  **ルーティング設定**: 画面遷移（CARD LIST ⇔ DECK LIST ⇔ PREVIEW）の設定。

**STEP 4: 機能実装（優先度順）（今ここ）**
1.  **カードリスト画面（完了）**:
    * 仮想スクロールの実装（5列グリッド）。
    * 詳細モーダル表示（パラレル画像切替のUI実装）。
    * **検索・詳細絞り込み機能（Deep Search）**。
2.  **デッキ構築画面**:
    * カードプールからの追加、デッキエリアでの削除。
    * **「同名4枚制限」ロジックの実装**。
3.  **プレビュー・保存**:
    * `html2canvas`を用いた画像保存機能。
4.  **Solo Play（モック）**:
    * 見た目の枠組みだけを作成。

**STEP 5: 調整・仕上げ**
1.  **ID修正ツール**: `id_manager.php`の実装。
2.  **ブラッシュアップ**: スマホ実機でのスクロール感度調整、`overscroll-behavior`の確認。
3.  **最終デプロイ**: サーバーへの配置とBasic認証設定。
